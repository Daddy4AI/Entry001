<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复习单词</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        table {
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
        .hidden-word {
            color: transparent;
        }
        .floating-button {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 30px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
        }
    </style>
</head>
<body>
    <h1>第<span id="examId">[todayExam_id]</span>次复习，继续加油</h1>
    
    <h2>需要复习的单词列表</h2>
    <table id="wordTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>单词</th>
                <th>输入</th>
                <th>结果</th>
            </tr>
        </thead>
        <tbody>
            <!-- 单词列表将通过JavaScript插入 -->
        </tbody>
    </table>

    <button id="startTestButton" class="floating-button">开始测试</button>

    <script type="module">
        import { database } from './firebaseConfig.js';
        import { ref, get } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

        let todayTestList = [];
        let maxWordN = 5; // 假设从 Firebase 读取的 maxWordN 为 5
        let todayExamId = 1; // 假设当前 exam_id 为 1，这个值可以从 Firebase 获取
        document.getElementById('examId').textContent = todayExamId;

        async function loadTodayWords() {
            // 从 Firebase 中获取今天的复习单词
            const wordListRef = ref(database, 'todayWordList');
            const snapshot = await get(wordListRef);

            if (snapshot.exists()) {
                const todayWordList = snapshot.val();
                todayTestList = todayWordList.slice(0, maxWordN); // 只取 maxWordN 个单词作为 todayTestList
                displayWords(todayWordList);
            } else {
                console.error('今天没有复习单词');
            }
        }

        function displayWords(wordList) {
            const tbody = document.querySelector('#wordTable tbody');
            tbody.innerHTML = ''; // 清空表格

            wordList.forEach((word, index) => {
                const isTodayTestWord = index < maxWordN;
                const wordId = index + 1;
                const hiddenWord = '*'.repeat(10);

                const row = document.createElement('tr');

                const idCell = document.createElement('td');
                idCell.textContent = wordId;
                row.appendChild(idCell);

                const wordCell = document.createElement('td');
                wordCell.textContent = word.word;
                wordCell.classList.add('hidden-word');
                wordCell.addEventListener('click', function() {
                    wordCell.textContent = word.word;
                });
                row.appendChild(wordCell);

                const inputCell = document.createElement('td');
                if (isTodayTestWord) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.addEventListener('focus', function() {
                        wordCell.textContent = hiddenWord;
                    });
                    input.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            const inputValue = input.value.trim().toLowerCase();
                            if (inputValue === word.word.toLowerCase()) {
                                resultCell.textContent = '正确';
                                resultCell.classList.add('correct');
                                moveToNextInput(input);
                                checkCompletion();
                            } else {
                                resultCell.textContent = '错误，再尝试';
                                resultCell.classList.add('incorrect');
                                input.value = ''; // 清空输入框
                                input.focus(); // 重新获取焦点
                            }
                        }
                    });
                    inputCell.appendChild(input);
                }
                row.appendChild(inputCell);

                const resultCell = document.createElement('td');
                resultCell.textContent = '';
                row.appendChild(resultCell);

                tbody.appendChild(row);
            });
        }

        function moveToNextInput(currentInput) {
            const inputs = document.querySelectorAll('input');
            const currentIndex = Array.from(inputs).indexOf(currentInput);
            if (currentIndex < inputs.length - 1) {
                inputs[currentIndex + 1].focus();
            }
        }

        function checkCompletion() {
            const allCorrect = Array.from(document.querySelectorAll('.correct')).length === todayTestList.length;
            if (allCorrect) {
                document.getElementById('startTestButton').style.display = 'block';
            }
        }

        document.getElementById('startTestButton').addEventListener('click', function() {
            window.location.href = 'testing.html';
        });

        window.addEventListener('load', loadTodayWords);
    </script>
</body>
</html>
