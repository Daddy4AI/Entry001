<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Words</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 80%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .hidden-word {
            cursor: pointer;
        }
        .floating-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: none;
        }
        footer {
            text-align: center;
            font-size: 12px;
            color: grey;
            margin-top: 50px;
        }
    </style>
</head>
<body>
    <h1 id="title"></h1>
    <h2>需要复习的单词列表</h2>
    <table id="wordTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>单词</th>
                <th>播放</th>
                <th>拼写</th>
                <th>复习结果</th>
            </tr>
        </thead>
        <tbody>
            <!-- 动态填充单词列表 -->
        </tbody>
    </table>
    <button id="startTestButton" class="floating-button">开始测试</button>

    <footer>version 001</footer>

    <script type="module">
        import { database } from './firebaseConfig.js';
        import { ref, get } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

        let todayWordList = [];
        let maxWordN = 10;
        let todayExamId = 0;

        async function initPage() {
            const examSettingsRef = ref(database, 'examSettings');
            const examRef = ref(database, 'Examlist');
            const snapshot = await get(examSettingsRef);
            if (snapshot.exists()) {
                maxWordN = snapshot.val().maxWordN || 10;
            }

            const examSnapshot = await get(examRef);
            if (examSnapshot.exists()) {
                todayExamId = Math.max(...Object.values(examSnapshot.val()).map(exam => exam.exam_id)) + 1;
            }

            document.getElementById('title').textContent = `第${todayExamId}次复习，继续加油`;

            // 假设 todayWordList 从 index.html 传递，或者通过缓存等方式存储
            todayWordList = JSON.parse(localStorage.getItem("todayWordList")) || [];

            renderTable();
        }

        function renderTable() {
            const tableBody = document.getElementById('wordTable').querySelector('tbody');
            tableBody.innerHTML = '';

            todayWordList.forEach((word, index) => {
                const row = document.createElement('tr');

                const idCell = document.createElement('td');
                idCell.textContent = word.id;
                row.appendChild(idCell);

                const wordCell = document.createElement('td');
                wordCell.textContent = word.word;
                wordCell.classList.add('word-cell');
                wordCell.dataset.word = word.word;
                row.appendChild(wordCell);

                const playCell = document.createElement('td');
                const playButton = document.createElement('button');
                playButton.textContent = "播放";
                playButton.onclick = () => playAudio(word.word);
                playCell.appendChild(playButton);
                row.appendChild(playCell);

                const inputCell = document.createElement('td');
                if (index < maxWordN) {
                    const inputField = document.createElement('input');
                    inputField.type = 'text';
                    inputField.onfocus = () => hideWordAndPlay(wordCell, word.word);
                    inputField.onblur = () => showWord(wordCell, word.word);
                    inputField.onkeypress = (e) => handleKeyPress(e, inputField, wordCell, word.word, row, index);
                    inputCell.appendChild(inputField);
                }
                row.appendChild(inputCell);

                const resultCell = document.createElement('td');
                resultCell.classList.add('result-cell');
                row.appendChild(resultCell);

                tableBody.appendChild(row);
            });
        }

        function hideWordAndPlay(cell, word) {
            cell.textContent = '*'.repeat(10);
            playAudio(word);
        }

        function showWord(cell, word) {
            cell.textContent = word;
        }

        function playAudio(word) {
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US';
            speechSynthesis.speak(utterance);
        }

        function handleKeyPress(e, inputField, wordCell, word, row, index) {
            if (e.key === 'Enter') {
                if (inputField.value.toLowerCase() === word.toLowerCase()) {
                    row.querySelector('.result-cell').textContent = '正确';
                    moveToNextInput(index + 1);
                } else {
                    row.querySelector('.result-cell').textContent = '错误，再尝试';
                    inputField.value = '';
                    inputField.focus();
                }
                checkCompletion();
            }
        }

        function moveToNextInput(nextIndex) {
            const nextInput = document.querySelector(`tbody tr:nth-child(${nextIndex + 1}) input`);
            if (nextInput) {
                nextInput.focus();
            }
        }

        function checkCompletion() {
            const allCorrect = Array.from(document.querySelectorAll('.result-cell'))
                .slice(0, maxWordN)
                .every(cell => cell.textContent === '正确');

            if (allCorrect) {
                document.getElementById('startTestButton').style.display = 'block';
            }
        }

        document.getElementById('startTestButton').onclick = () => {
            window.location.href = "testing.html";
        };

        window.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
