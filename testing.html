<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing Words</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .loading {
            font-size: 14px;
            color: grey;
            margin-bottom: 10px;
        }
        .buttons {
            margin: 20px;
        }
        .word-display {
            font-size: 24px;
            margin: 20px;
            cursor: pointer;
        }
        .progress-display, .word-display, input[type="text"] {
            width: 50%;
            text-align: center;
            margin: auto;
        }
        input[type="text"] {
            padding: 10px;
            font-size: 18px;
        }
        .footer {
            margin-top: 40px;
            font-size: 12px;
            color: grey;
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingMessage">正在加载单词，请稍后...</div>
    <h1 id="title"></h1>
    <h2 id="progressTitle"></h2>

    <div class="buttons">
        <button id="playSoundButton">播放单词</button>
        <button id="nextWordButton" disabled>下一个单词</button>
    </div>

    <div class="word-display" id="wordDisplay">**********</div>
    <div class="progress-display" id="wordTestProgress">测试状态</div>

    <input type="text" id="inputField" placeholder="输入单词拼写" autocomplete="off">

    <div class="footer">version 003</div>

    <script type="module">
        import { db } from './firebaseConfig.js';
        import { doc, getDoc, setDoc, updateDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        let todayExamId = 0;
        let todayTestList = [];
        let maxWordN = 10;
        let currentWordIndex = 0;
        let currentWord = null;
        let retestCount = 0;

        async function initPage() {
            try {
                // 获取 examSettings 的 maxWordN 设置
                const maxWordNDoc = await getDoc(doc(db, 'examSettings', 'maxWordN'));
                if (maxWordNDoc.exists()) {
                    maxWordN = maxWordNDoc.data().maxWordN || 10;
                }

                // 获取今天的 examId
                const examSnapshot = await getDocs(collection(db, 'examList'));
                if (!examSnapshot.empty) {
                    todayExamId = Math.max(...examSnapshot.docs.map(doc => doc.data().exam_id)) + 1;
                }

                document.getElementById('title').textContent = `开始今天的测试，这是第${todayExamId}次测试`;

                // 从 localStorage 获取 todayTestList
                todayTestList = JSON.parse(localStorage.getItem("todayWordList")).slice(0, maxWordN) || [];
                if (!todayTestList.length) {
                    alert("没有找到今天的测试单词，请检查是否已经生成 todayTestList");
                    return;
                }

                document.getElementById('loadingMessage').style.display = "none";
                loadWord();
            } catch (error) {
                console.error("Error initializing page:", error);
            }
        }

        async function loadWord() {
            if (currentWordIndex >= todayTestList.length) {
                alert("完成今天的测试");
                window.location.href = "result.html";
                return;
            }

            currentWord = todayTestList[currentWordIndex];
            document.getElementById("progressTitle").textContent = `${currentWordIndex + 1} of ${maxWordN}个单词`;
            document.getElementById("wordDisplay").textContent = "**********";
            document.getElementById("wordTestProgress").textContent = "测试状态";
            document.getElementById("inputField").value = "";
            retestCount = 0;

            playAudio(currentWord.word);
        }

        async function playAudio(word) {
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US';
            speechSynthesis.speak(utterance);
        }

        async function playCurrentWord() {
            playAudio(currentWord.word);
        }

        async function resetWordDisplay() {
            document.getElementById("wordDisplay").textContent = "**********";
        }

        async function checkSpelling() {
            const inputField = document.getElementById("inputField");
            const userSpelling = inputField.value.trim().toLowerCase();
            const correctSpelling = currentWord.word.toLowerCase();

            if (userSpelling === correctSpelling) {
                if (retestCount === 0) {
                    // First attempt is correct, save the result and move to the next word
                    await saveTestResult(true);
                    document.getElementById("wordTestProgress").textContent = "拼写正确！准备下一个单词";
                    document.getElementById("nextWordButton").disabled = false;

                    setTimeout(() => {
                        loadNextWord(); // Automatically load the next word after 1 second
                        inputField.value = "";
                        inputField.focus();
                    }, 1000);

                } else {
                    // Retest attempt is correct, increment retest count
                    retestCount++;
                    document.getElementById("wordTestProgress").textContent = `完成第${retestCount - 1}次测试，还有${4 - retestCount}次`;

                    if (retestCount === 4) {
                        document.getElementById("nextWordButton").disabled = false;
                        document.getElementById("wordTestProgress").textContent = "准备下一个单词";

                        setTimeout(() => {
                            loadNextWord(); // Automatically load the next word after 1 second
                            inputField.value = "";
                            inputField.focus();
                        }, 1000);

                    } else {
                        // Retest correct but not final attempt, reset input for next retest
                        setTimeout(() => {
                            inputField.value = "";
                            inputField.focus();
                        }, 1000);
                    }
                }

            } else {
                if (retestCount === 0) {
                    // First attempt is incorrect, save the result and increment retest count
                    await saveTestResult(false);
                    document.getElementById("wordTestProgress").textContent = "拼写错误，再尝试3次";
                    retestCount++;
                } else if (retestCount < 4) {
                    // Retest is incorrect, prompt user to try again
                    document.getElementById("wordTestProgress").textContent = "拼写不正确，继续尝试";

                    setTimeout(() => {
                        inputField.value = "";
                        inputField.focus();
                    }, 1000);
                }
            }
        }

        async function saveTestResult(isCorrect) {
            const wordRef = doc(db, 'testResult', currentWord.id.toString());
            const resultSnapshot = await getDoc(wordRef);
            
            const currentTimestamp = new Date().toISOString();

            if (resultSnapshot.exists()) {
                // Update if the document exists
                const data = resultSnapshot.data();
                const maxReviewId = data.review_attempt || 0;

                // Increment review_attempt if the word is tested correctly for the first time or any subsequent attempt
                let newReviewId = maxReviewId;
                if (isCorrect && maxReviewId === 0) {
                    newReviewId = 1;
                } else if (isCorrect && maxReviewId > 0) {
                    newReviewId++;
                }

                // Prepare the new attempt details
                const newAttempt = {
                    test_result: isCorrect,
                    exam_id: todayExamId,
                    timestamp: currentTimestamp
                };

                // Update Firestore document
                await updateDoc(wordRef, {
                    review_attempt: newReviewId,
                    last_exam_id: todayExamId,
                    test_attempts: [...(data.test_attempts || []), newAttempt] // Append new attempt
                });
            } else {
                // Create if the document does not exist
                const newAttempt = {
                    test_result: isCorrect,
                    exam_id: todayExamId,
                    timestamp: currentTimestamp
                };

                await setDoc(wordRef, {
                    id: currentWord.id,
                    review_attempt: isCorrect ? 1 : 0, // Set to 0 if incorrect, 1 if correct
                    last_exam_id: todayExamId,
                    test_attempts: [newAttempt] // Start with the first attempt
                });
            }

            document.getElementById("wordDisplay").textContent = currentWord.word;
            document.getElementById("inputField").value = "";
        }

        function loadNextWord() {
            document.getElementById("nextWordButton").disabled = true;
            currentWordIndex++;
            loadWord();
        }

        document.getElementById("playSoundButton").addEventListener("click", playCurrentWord);
        document.getElementById("nextWordButton").addEventListener("click", loadNextWord);
        document.getElementById("inputField").addEventListener("focus", resetWordDisplay);
        document.getElementById("inputField").addEventListener("keypress", (e) => {
            if (e.key === 'Enter') {
                checkSpelling();
            }
        });

        window.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
