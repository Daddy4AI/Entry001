<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing Words</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .loading {
            font-size: 14px;
            color: grey;
            margin-bottom: 10px;
        }
        .buttons {
            margin: 20px;
        }
        .word-display {
            font-size: 24px;
            margin: 20px;
            cursor: pointer;
        }
        .progress-display, .word-display, input[type="text"] {
            width: 50%;
            text-align: center;
            margin: auto;
        }
        input[type="text"] {
            padding: 10px;
            font-size: 18px;
        }
        .footer {
            margin-top: 40px;
            font-size: 12px;
            color: grey;
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingMessage">正在加载单词，请稍后...</div>
    <h1 id="title"></h1>
    <h2 id="progressTitle"></h2>

    <div class="buttons">
        <button id="playSoundButton">播放单词</button>
        <button id="nextWordButton" disabled>下一个单词</button>
    </div>

    <div class="word-display" id="wordDisplay">**********</div>
    <div class="progress-display" id="wordTestProgress">测试状态</div>

    <input type="text" id="inputField" placeholder="输入单词拼写" autocomplete="off">

    <div class="footer">version 009</div>

    <script type="module">
        import { db } from './firebaseConfig.js';
        import { doc, setDoc, getDoc, collection, getDocs, updateDoc } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        // 从 localStorage 获取 maxWordN 和 todayExamId
        let maxWordN = parseInt(localStorage.getItem('maxWordN'), 10);
        let todayExamId = parseInt(localStorage.getItem('todayExamId'), 10);
        
        let todayTestList = [];
        let currentWordIndex = 0;
        let currentWord = null;
        let retestCount = 0;
        let examResults = []; // 用于存储本次考试的结果

        async function initPage() {
            try {
                console.log('Starting initial setup...');

                // 如果 localStorage 中没有 maxWordN 和 todayExamId，则从 Firestore 获取并保存
                if (isNaN(maxWordN) || isNaN(todayExamId)) {
                    const [maxWordNDoc, examSnapshot] = await Promise.all([
                        isNaN(maxWordN) ? getDoc(doc(db, 'examSettings', 'maxWordN')) : null,
                        isNaN(todayExamId) ? getDocs(collection(db, 'examList')) : null
                    ]);

                    if (isNaN(maxWordN) && maxWordNDoc && maxWordNDoc.exists()) {
                        maxWordN = maxWordNDoc.data().maxWordN || 25;
                        localStorage.setItem('maxWordN', maxWordN);
                    } else if (isNaN(maxWordN)) {
                        maxWordN = 25;
                        localStorage.setItem('maxWordN', maxWordN);
                    }

                    if (isNaN(todayExamId) && examSnapshot) {
                        todayExamId = examSnapshot.empty ? 1 : Math.max(...examSnapshot.docs.map(doc => doc.data().exam_id)) + 1;
                        localStorage.setItem('todayExamId', todayExamId);
                    }
                }

                // 创建新的考试记录
                const examListRef = doc(db, 'examList', todayExamId.toString());
                const examTimeStart = new Date().toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' });
                await setDoc(examListRef, {
                    id: todayExamId.toString(),
                    exam_id: todayExamId,
                    exam_time_start: examTimeStart,
                    exam_time_end: null
                });

                document.getElementById('title').textContent = `开始今天的测试，这是第${todayExamId}次测试`;

                // 从 localStorage 获取 todayTestList
                todayTestList = JSON.parse(localStorage.getItem("todayWordList")).slice(0, maxWordN) || [];
                if (!todayTestList.length) {
                    alert("没有找到今天的测试单词，请检查是否已经生成 todayTestList");
                    return;
                }

                document.getElementById('loadingMessage').style.display = "none";
                loadWord();
            } catch (error) {
                console.error("Error initializing page:", error);
            }
        }

        async function loadWord() {
            if (currentWordIndex >= todayTestList.length) {
                await saveAllResults();
                alert("完成今天的测试");
                window.location.href = "result.html";
                return;
            }

            currentWord = todayTestList[currentWordIndex];
            document.getElementById("progressTitle").textContent = `${currentWordIndex + 1} of ${maxWordN}个单词`;
            document.getElementById("wordDisplay").textContent = "**********";
            document.getElementById("wordTestProgress").textContent = "测试状态";
            document.getElementById("inputField").value = "";
            retestCount = 0;

            playAudio(currentWord.word);
        }

        async function playAudio(word) {
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US';
            speechSynthesis.speak(utterance);
        }

        function playCurrentWord() {
            playAudio(currentWord.word);
        }

        function resetWordDisplay() {
            document.getElementById("wordDisplay").textContent = "**********";
        }

        async function checkSpelling() {
            const inputField = document.getElementById("inputField");
            const userSpelling = inputField.value.trim().toLowerCase();
            const correctSpelling = currentWord.word.toLowerCase();

            if (userSpelling === correctSpelling) {
                if (retestCount === 0) {
                    // 第一次测试正确，保存结果并移动到下一个单词
                    saveTestResult(true);
                    document.getElementById("wordTestProgress").textContent = "拼写正确！准备下一个单词";
                    document.getElementById("nextWordButton").disabled = false;

                    setTimeout(() => {
                        loadNextWord();
                        inputField.value = "";
                        inputField.focus();
                    }, 1000);
                } else {
                    retestCount++;
                    document.getElementById("wordTestProgress").textContent = `完成第${retestCount - 1}次测试，还有${4 - retestCount}次`;

                    if (retestCount === 4) {
                        document.getElementById("nextWordButton").disabled = false;
                        document.getElementById("wordTestProgress").textContent = "准备下一个单词";

                        setTimeout(() => {
                            loadNextWord();
                            inputField.value = "";
                            inputField.focus();
                        }, 1000);
                    } else {
                        setTimeout(() => {
                            inputField.value = "";
                            inputField.focus();
                        }, 1000);
                    }
                }
            } else {
                if (retestCount === 0) {
                    saveTestResult(false);
                    document.getElementById("wordTestProgress").textContent = "拼写错误，再尝试3次";
                    retestCount++;
                } else if (retestCount < 4) {
                    document.getElementById("wordTestProgress").textContent = "拼写不正确，继续尝试";

                    setTimeout(() => {
                        inputField.value = "";
                        inputField.focus();
                    }, 1000);
                }
            }
        }

        function saveTestResult(isCorrect) {
            const currentTimestamp = new Date().toISOString();

            const testResult = {
                word_id: currentWord.id,
                test_result: isCorrect,
                exam_id: todayExamId,
                timestamp: currentTimestamp
            };

            examResults.push(testResult); // 将结果添加到本地数组中
        }

        async function saveAllResults() {
            try {
                const examListRef = doc(db, 'examList', todayExamId.toString());
                const examEndTime = new Date().toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' });
                
                // 更新考试结束时间
                await updateDoc(examListRef, {
                    exam_time_end: examEndTime
                });

                // 批量写入每个单词的测试结果
                for (let result of examResults) {
                    const wordRef = doc(db, 'testResult', result.word_id.toString());
                    const resultSnapshot = await getDoc(wordRef);

                    if (resultSnapshot.exists()) {
                        const data = resultSnapshot.data();
                        const newAttempt = {
                            test_result: result.test_result,
                            exam_id: result.exam_id,
                            timestamp: result.timestamp
                        };
                        
                        // 更新文档，将新的测试结果追加到 `test_attempts`
                        await updateDoc(wordRef, {
                            last_exam_id: result.exam_id,
                            test_attempts: [...(data.test_attempts || []), newAttempt]
                        });
                    } else {
                        // 创建新的文档
                        await setDoc(wordRef, {
                            id: result.word_id,
                            last_exam_id: result.exam_id,
                            test_attempts: [{ test_result: result.test_result, exam_id: result.exam_id, timestamp: result.timestamp }]
                        });
                    }
                }
                console.log("所有测试结果已成功保存到 Firestore");
            } catch (error) {
                console.error("Error saving results to Firestore:", error);
            }
        }

        function loadNextWord() {
            document.getElementById("nextWordButton").disabled = true;
            currentWordIndex++;
            loadWord();
        }

        document.getElementById("playSoundButton").addEventListener("click", playCurrentWord);
        document.getElementById("nextWordButton").addEventListener("click", loadNextWord);
        document.getElementById("inputField").addEventListener("focus", resetWordDisplay);
        document.getElementById("inputField").addEventListener("keypress", (e) => {
            if (e.key === 'Enter') {
                checkSpelling();
            }
        });

        window.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
