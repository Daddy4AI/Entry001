<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing Words</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .loading {
            font-size: 14px;
            color: grey;
            margin-bottom: 10px;
        }
        .buttons {
            margin: 20px;
        }
        .word-display {
            font-size: 24px;
            margin: 20px;
            cursor: pointer;
        }
        .progress-display, .word-display, input[type="text"] {
            width: 50%;
            text-align: center;
            margin: auto;
        }
        input[type="text"] {
            padding: 10px;
            font-size: 18px;
        }
        .footer {
            margin-top: 40px;
            font-size: 12px;
            color: grey;
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingMessage">正在加载单词，请稍后...</div>
    <h1 id="title"></h1>
    <h2 id="progressTitle"></h2>

    <div class="buttons">
        <button id="playSoundButton">播放单词</button>
        <button id="nextWordButton" disabled>下一个单词</button>
    </div>

    <div class="word-display" id="wordDisplay">**********</div>
    <div class="progress-display" id="wordTestProgress">测试状态</div>

    <input type="text" id="inputField" placeholder="输入单词拼写" autocomplete="off">

    <div class="footer">version 006</div>

    <script type="module">
        import { db } from './firebaseConfig.js';
        import { doc, getDoc, setDoc, updateDoc, addDoc } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        // 从 localStorage 获取 maxWordN 和 todayExamId
        const maxWordN = parseInt(localStorage.getItem('maxWordN'), 10);
        const todayExamId = parseInt(localStorage.getItem('todayExamId'), 10);
        
        let todayTestList = [];
        let currentWordIndex = 0;
        let currentWord = null;
        let retestCount = 0;

        async function initPage() {
            try {
                if (isNaN(maxWordN) || isNaN(todayExamId)) {
                    console.error("Error: maxWordN or todayExamId not found in localStorage.");
                    return;
                }

                console.log(`Loaded from localStorage - Max Word Number: ${maxWordN}, Today Exam ID: ${todayExamId}`);

                // 创建新的考试记录
                const examListRef = doc(db, 'examList', todayExamId.toString());
                const examTimeStart = new Date().toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' });
                await setDoc(examListRef, {
                    id: todayExamId.toString(),
                    exam_id: todayExamId,
                    exam_time_start: examTimeStart,
                    exam_time_end: null
                });

                document.getElementById('title').textContent = `开始今天的测试，这是第${todayExamId}次测试`;

                // 从 localStorage 获取 todayTestList
                todayTestList = JSON.parse(localStorage.getItem("todayWordList")).slice(0, maxWordN) || [];
                if (!todayTestList.length) {
                    alert("没有找到今天的测试单词，请检查是否已经生成 todayTestList");
                    return;
                }

                document.getElementById('loadingMessage').style.display = "none";
                loadWord();
            } catch (error) {
                console.error("Error initializing page:", error);
            }
        }

        async function loadWord() {
            if (currentWordIndex >= todayTestList.length) {
                // 记录考试结束时间
                const examEndTime = new Date().toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' });
                const examListRef = doc(db, 'examList', todayExamId.toString());
                try {
                    await updateDoc(examListRef, {
                        exam_time_end: examEndTime
                    });
                    console.log('考试结束时间已记录');
                } catch (error) {
                    console.error('Error updating exam end time:', error);
                }

                alert("完成今天的测试");
                window.location.href = "result.html";
                return;
            }

            currentWord = todayTestList[currentWordIndex];
            document.getElementById("progressTitle").textContent = `${currentWordIndex + 1} of ${maxWordN}个单词`;
            document.getElementById("wordDisplay").textContent = "**********";
            document.getElementById("wordTestProgress").textContent = "测试状态";
            document.getElementById("inputField").value = "";
            retestCount = 0;

            playAudio(currentWord.word);
        }

        async function playAudio(word) {
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US';
            speechSynthesis.speak(utterance);
        }

        function playCurrentWord() {
            playAudio(currentWord.word);
        }

        function resetWordDisplay() {
            document.getElementById("wordDisplay").textContent = "**********";
        }

        async function checkSpelling() {
            const inputField = document.getElementById("inputField");
            const userSpelling = inputField.value.trim().toLowerCase();
            const correctSpelling = currentWord.word.toLowerCase();

            if (userSpelling === correctSpelling) {
                if (retestCount === 0) {
                    await saveTestResult(true);
                    document.getElementById("wordTestProgress").textContent = "拼写正确！准备下一个单词";
                    document.getElementById("nextWordButton").disabled = false;

                    setTimeout(() => {
                        loadNextWord();
                        inputField.value = "";
                        inputField.focus();
                    }, 1000);

                } else {
                    retestCount++;
                    document.getElementById("wordTestProgress").textContent = `完成第${retestCount - 1}次测试，还有${4 - retestCount}次`;

                    if (retestCount === 4) {
                        document.getElementById("nextWordButton").disabled = false;
                        document.getElementById("wordTestProgress").textContent = "准备下一个单词";

                        setTimeout(() => {
                            loadNextWord();
                            inputField.value = "";
                            inputField.focus();
                        }, 1000);
                    } else {
                        setTimeout(() => {
                            inputField.value = "";
                            inputField.focus();
                        }, 1000);
                    }
                }
            } else {
                if (retestCount === 0) {
                    await saveTestResult(false);
                    document.getElementById("wordTestProgress").textContent = "拼写错误，再尝试3次";
                    retestCount++;
                } else if (retestCount < 4) {
                    document.getElementById("wordTestProgress").textContent = "拼写不正确，继续尝试";

                    setTimeout(() => {
                        inputField.value = "";
                        inputField.focus();
                    }, 1000);
                }
            }
        }

        async function saveTestResult(isCorrect) {
            const wordRef = doc(db, 'testResult', currentWord.id.toString());
            const currentTimestamp = new Date().toISOString();

            (async () => {
                try {
                    const resultSnapshot = await getDoc(wordRef);

                    if (resultSnapshot.exists()) {
                        const data = resultSnapshot.data();
                        const maxReviewId = data.review_attempt || 0;

                        let newReviewId = maxReviewId;
                        if (isCorrect && maxReviewId === 0) {
                            newReviewId = 1;
                        } else if (isCorrect && maxReviewId > 0) {
                            newReviewId++;
                        }

                        const newAttempt = {
                            test_result: isCorrect,
                            exam_id: todayExamId,
                            timestamp: currentTimestamp
                        };

                        await updateDoc(wordRef, {
                            review_attempt: newReviewId,
                            last_exam_id: todayExamId,
                            test_attempts: [...(data.test_attempts || []), newAttempt]
                        });
                    } else {
                        const newAttempt = {
                            test_result: isCorrect,
                            exam_id: todayExamId,
                            timestamp: currentTimestamp
                        };

                        await setDoc(wordRef, {
                            id: currentWord.id,
                            review_attempt: isCorrect ? 1 : 0,
                            last_exam_id: todayExamId,
                            test_attempts: [newAttempt]
                        });
                    }
                } catch (error) {
                    console.error('Error saving test result:', error);
                }
            })();

            document.getElementById("wordDisplay").textContent = currentWord.word;
            document.getElementById("inputField").value = "";
        }

        function loadNextWord() {
            document.getElementById("nextWordButton").disabled = true;
            currentWordIndex++;
            loadWord();
        }

        document.getElementById("playSoundButton").addEventListener("click", playCurrentWord);
        document.getElementById("nextWordButton").addEventListener("click", loadNextWord);
        document.getElementById("inputField").addEventListener("focus", resetWordDisplay);
        document.getElementById("inputField").addEventListener("keypress", (e) => {
            if (e.key === 'Enter') {
                checkSpelling();
            }
        });

        window.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
