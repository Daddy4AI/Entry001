<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build a Strong Vocabulary</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
        }
        table {
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
        footer {
            text-align: center;
            font-size: 12px;
            color: grey;
            margin-top: 50px;
        }
    </style>
</head>
<body>
    <h1>Build a Strong Vocabulary</h1>
    <div id="setupMessage" style="display: none;">Initializing...</div>
    <div id="errorMessage" style="display: none; color: red;"></div>

    <button id="viewWordsButton">查看</button>
    <button id="reviewWordsButton">复习</button>
    <button id="testWordsButton">测试</button>

    <div id="wordListContainer"></div>

    <footer>version 005</footer>

    <script type="module">
        import { db } from './firebaseConfig.js';
        import { doc, setDoc, getDoc, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        async function getMaxWordN() {
            try {
                const docRef = doc(db, 'examSettings', 'maxWordN');
                const snapshot = await getDoc(docRef);
                return snapshot.exists() ? snapshot.data().maxWordN : 25;  // 默认 25
            } catch (error) {
                console.error('获取 maxWordN 时出错:', error);
                return 25;
            }
        }

        async function initialSetup() {
            try {
                console.log('Starting initial setup...');

                // 检查 wordlist 是否存在
                const wordlistSnapshot = await getDocs(collection(db, 'wordlist'));
                if (wordlistSnapshot.empty) {
                    document.getElementById('setupMessage').style.display = 'none';
                    document.getElementById('errorMessage').textContent = '没有单词清单，请上传需要复习的单词';
                    document.getElementById('errorMessage').style.display = 'block';
                    throw new Error('Wordlist 不存在');
                }

                const testResultRef = doc(db, 'testResult', '0');
                const testResultSnapshot = await getDoc(testResultRef);

                if (!testResultSnapshot.exists()) {
                    console.warn('TestResult 不存在，正在创建初始记录...');
                    const initialRecord = {
                        id: 0,
                        word_id: 0,
                        exam_id: 0,
                        test_result: false,
                        test_attempt: 0,
                        review_attempt: 0
                    };
                    await setDoc(testResultRef, initialRecord);
                    console.log('testResult 初始记录已创建');
                } else {
                    console.log('testResult 已存在，无需创建。');
                }

                // 检查 examList 是否存在，如果不存在，初始化 examList 数据库
                const examListRef = doc(db, 'examList', '0');
                const examListSnapshot = await getDoc(examListRef);
                if (!examListSnapshot.exists()) {
                    console.warn('examList 不存在，正在初始化...');
                    const initialExam = {
                        id: 0,
                        exam_id: 0,
                        exam_time_start: new Date().toISOString(),
                        exam_time_end: null
                    };
                    await setDoc(examListRef, initialExam);
                    console.log('examList 数据库已初始化');
                }

                document.getElementById('setupMessage').textContent = '系统初始设置完成，您可以开始使用系统';
            } catch (error) {
                console.error('初始设置失败:', error);
            }
        }

        function setWordStatus(word, result) {
            if (!result || result.test_attempt === 0) {
                if (!result || result.review_attempt === 0) {
                    return "新单词";
                }
            } else if (result.review_attempt === 0) {
                return "初始复习";
            } else {
                return `第${result.review_attempt}次复习`;
            }
        }

        async function loadTodayWords() {
            const maxWordN = await getMaxWordN();
            const todayWordList = [];

            const [wordSnapshot, testResultSnapshot] = await Promise.all([
                getDocs(collection(db, 'wordlist')),
                getDocs(collection(db, 'testResult'))
            ]);

            if (wordSnapshot.empty || testResultSnapshot.empty) {
                console.error('No wordlist or test results found.');
                return;
            }

            const words = wordSnapshot.docs.map(doc => doc.data());
            const testResults = {};
            testResultSnapshot.forEach(doc => {
                testResults[doc.id] = doc.data();
            });

            function addWordsToList(filteredWords) {
                const remainingSlots = maxWordN - todayWordList.length;
                todayWordList.push(...filteredWords.slice(0, remainingSlots));
            }

            const todayExamId = Math.max(...Object.values(testResults).map(r => r.exam_id)) + 1;

            const YWWord = words.filter(word => {
                const result = testResults[word.id];
                word.status = setWordStatus(word, result);
                return (
                    result &&
                    result.review_attempt === 0 &&
                    result.exam_id === todayExamId - 1 &&
                    result.test_result === false
                );
            });
            addWordsToList(YWWord);

            const R2Word = words.filter(word => {
                const result = testResults[word.id];
                word.status = setWordStatus(word, result);
                return (
                    result &&
                    result.review_attempt === 1 &&
                    result.exam_id <= todayExamId - 2
                );
            });
            addWordsToList(R2Word);

            const R6Word = words.filter(word => {
                const result = testResults[word.id];
                word.status = setWordStatus(word, result);
                return (
                    result &&
                    result.review_attempt === 2 &&
                    result.exam_id <= todayExamId - 6
                );
            });
            addWordsToList(R6Word);

            const R13Word = words.filter(word => {
                const result = testResults[word.id];
                word.status = setWordStatus(word, result);
                return (
                    result &&
                    result.review_attempt === 3 &&
                    result.exam_id <= todayExamId - 13
                );
            });
            addWordsToList(R13Word);

            const R20Word = words.filter(word => {
                const result = testResults[word.id];
                word.status = setWordStatus(word, result);
                return (
                    result &&
                    result.review_attempt === 4 &&
                    result.exam_id <= todayExamId - 20
                );
            });
            addWordsToList(R20Word);

            if (todayWordList.length < maxWordN) {
                const untestedWords = words.filter(word =>
                    !testResults[word.id] || testResults[word.id].test_attempt === 0
                );
                untestedWords.forEach(word => {
                    word.status = "新单词";
                });
                addWordsToList(untestedWords);
            }

            displayWords(todayWordList);

            // 保存 todayWordList 到 localStorage
            localStorage.setItem("todayWordList", JSON.stringify(todayWordList));
        }

        function displayWords(wordList) {
            if (wordList.length > 0) {
                let tableHtml = `<table>
                    <tr><th>单词</th><th>状态</th><th>翻译</th></tr>`;
                wordList.forEach(word => {
                    tableHtml += `<tr>
                        <td>${word.word}</td>
                        <td>${word.status}</td>
                        <td>${word.translation || 'N/A'}</td>
                    </tr>`;
                });
                tableHtml += "</table>";
                document.getElementById('wordListContainer').innerHTML = tableHtml;
            } else {
                document.getElementById('wordListContainer').innerHTML = "今天没有需要复习的单词。";
            }
        }

        window.addEventListener('load', async () => { // Add `async` here
            console.log('Page loaded. Running initial setup...');
            await initialSetup(); // Wait for initialSetup() to complete
            loadTodayWords(); // Run loadTodayWords() after initialSetup() finishes
        });

        document.getElementById('viewWordsButton').addEventListener('click', loadTodayWords);

        document.getElementById('reviewWordsButton').addEventListener('click', () => {
            window.location.href = "review.html";
        });

        document.getElementById('testWordsButton').addEventListener('click', () => {
            window.location.href = "testing.html";
        });
    </script>
</body>
</html>
