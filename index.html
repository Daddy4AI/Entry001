<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build a Strong Vocabulary</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
        }
        table {
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
        #stats {
            margin-top: 40px;
        }
        #chartContainer {
            width: 80%;
            margin: 20px auto;
        }
        footer {
            text-align: center;
            font-size: 12px;
            color: grey;
            margin-top: 50px;
        }
    </style>
</head>
<body>
    <h1>Build a Strong Vocabulary</h1>
    
    <!-- 功能按钮 -->
    <button id="viewWordsButton">查看</button>
    <button id="reviewWordsButton">复习</button>
    <button id="testWordsButton">测试</button>

    <!-- 显示单词表格 -->
    <div id="wordListContainer"></div>

    <!-- 统计信息 -->
    <div id="stats">
        <h2>复习单词测试次数分布</h2>
        <div id="chartContainer">
            <canvas id="testChart"></canvas>
        </div>

        <h2>过去5次考试的成绩</h2>
        <table id="testResultsTable">
            <thead>
                <tr>
                    <th>考试时间</th>
                    <th>单词数量</th>
                    <th>正确率</th>
                </tr>
            </thead>
            <tbody>
                <!-- 数据将通过JS填充 -->
            </tbody>
        </table>
    </div>

    <!-- 版本信息 -->
    <footer>
        version 001
    </footer>

    <script type="module">
        import { database } from './firebaseConfig.js';
        import { ref, get, child } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

        // 初始化数据
        async function initializeData() {
            const examRef = ref(database, 'examlist');
            const wordRef = ref(database, 'wordlist');
            const testResultRef = ref(database, 'TestResult');

            // 检查是否有考试数据
            const examSnapshot = await get(examRef);
            if (!examSnapshot.exists()) {
                // 没有考试记录，创建初始考试记录
                const initialExam = {
                    id: 1,
                    exam_id: 1,
                    exam_time_start: new Date().toISOString(),
                    exam_time_end: null
                };
                await set(ref(database, 'examlist/1'), initialExam);
                console.log("已创建初始考试记录");
            }

            // 检查是否有测试结果
            const testResultSnapshot = await get(testResultRef);
            if (!testResultSnapshot.exists()) {
                // 没有测试记录，创建初始测试结果
                const wordSnapshot = await get(wordRef);
                if (wordSnapshot.exists()) {
                    const words = wordSnapshot.val();
                    const testResults = {};
                    Object.keys(words).forEach((wordId, index) => {
                        testResults[index + 1] = {
                            id: index + 1,
                            word_id: wordId,
                            exam_id: 1,
                            test_result: false,  // 初始状态为未测试
                            test_attempt: 0,
                            review_attempt: 0
                        };
                    });
                    await set(ref(database, 'TestResult'), testResults);
                    console.log("已创建初始测试记录");
                }
            }
        }

        // 从 Firebase 加载今天复习的单词
        async function loadTodayWords() {
            try {
                const examRef = ref(database, 'examlist');
                const wordRef = ref(database, 'wordlist');
                const testResultRef = ref(database, 'TestResult');

                // 获取最大的 exam_id
                const examSnapshot = await get(examRef);
                if (!examSnapshot.exists()) {
                    console.error('No exams found.');
                    return;
                }

                const exams = examSnapshot.val();
                const examIds = Object.keys(exams).map(id => parseInt(exams[id].exam_id));
                const yestExamId = Math.max(...examIds);  // 昨天的最大 exam_id
                const todayExamId = yestExamId + 1;

                // 计算不同类型的单词
                const todayWordList = [];

                // 获取 wordlist 数据
                const wordSnapshot = await get(wordRef);
                if (!wordSnapshot.exists()) {
                    console.error('No wordlist found.');
                    return;
                }

                const words = wordSnapshot.val();
                const wordArray = Object.values(words);

                // 获取 TestResult 数据
                const testResultSnapshot = await get(testResultRef);
                if (!testResultSnapshot.exists()) {
                    console.error('No test results found.');
                    return;
                }

                const testResults = testResultSnapshot.val();

                // 为每个单词根据 test_attempt 和 review_attempt 设置状态
                wordArray.forEach(word => {
                    const testResult = Object.values(testResults).find(result => result.word_id === word.id);
                    if (testResult) {
                        if (testResult.test_attempt === 0 && testResult.review_attempt === 0) {
                            word.status = "新单词";
                        } else if (testResult.test_attempt > 0 && testResult.review_attempt === 0) {
                            word.status = "初始复习";
                        } else if (testResult.test_attempt > 0 && testResult.review_attempt === 1) {
                            word.status = "第1次复习";
                        } else if (testResult.test_attempt > 0 && testResult.review_attempt === 2) {
                            word.status = "第2次复习";
                        } else if (testResult.test_attempt > 0 && testResult.review_attempt === 3) {
                            word.status = "第3次复习";
                        } else if (testResult.test_attempt > 0 && testResult.review_attempt === 4) {
                            word.status = "第4次复习";
                        }
                    } else {
                        word.status = "新单词";
                    }
                });

                // 1. 获取昨天错误的新单词
                const YWWord = wordArray.filter(word => {
                    const testResult = Object.values(testResults).find(result => result.word_id === word.id && result.exam_id === (todayExamId - 1));
                    return testResult && testResult.test_result === false && testResult.review_attempt === 0;
                });
                todayWordList.push(...YWWord);

                // 2. 获取2天前的单词 (review_attempt: 1)
                const R2Word = wordArray.filter(word => {
                    const testResult = Object.values(testResults).find(result => result.word_id === word.id && result.exam_id <= (todayExamId - 2));
                    return testResult && testResult.review_attempt === 1;
                });
                todayWordList.push(...R2Word);

                // 3. 获取6天前的单词 (review_attempt: 2)
                const R6Word = wordArray.filter(word => {
                    const testResult = Object.values(testResults).find(result => result.word_id === word.id && result.exam_id <= (todayExamId - 6));
                    return testResult && testResult.review_attempt === 2;
                });
                todayWordList.push(...R6Word);

                // 4. 获取13天前的单词 (review_attempt: 3)
                const R13Word = wordArray.filter(word => {
                    const testResult = Object.values(testResults).find(result => result.word_id === word.id && result.exam_id <= (todayExamId - 13));
                    return testResult && testResult.review_attempt === 3;
                });
                todayWordList.push(...R13Word);

                // 5. 获取20天前的单词 (review_attempt: 4)
                const R20Word = wordArray.filter(word => {
                    const testResult = Object.values(testResults).find(result => result.word_id === word.id && result.exam_id <= (todayExamId - 20));
                    return testResult && testResult.review_attempt === 4;
                });
                todayWordList.push(...R20Word);

                // 6. 如果总数少于 maxWordN，从 wordlist 中加入未测试过的单词
                const maxWordN = 25;  // 假设 maxWordN 为25，这个值可以从 Firebase 中获取
                if (todayWordList.length < maxWordN) {
                    const untestedWords = wordArray.filter(word => {
                        const testResult = Object.values(testResults).find(result => result.word_id === word.id);
                        return !testResult;
                    });
                    const remainingWords = maxWordN - todayWordList.length;
                    todayWordList.push(...untestedWords.slice(0, remainingWords));
                }

                // 将 todayWordList 显示在页面上
                displayWords(todayWordList);
            } catch (error) {
                console.error('加载复习单词时出错:', error);
            }
        }

        function displayWords(wordList) {
            if (wordList.length > 0) {
                let tableHtml = `<table>
                    <tr><th>单词</th><th>状态</th><th>翻译</th></tr>`;
                wordList.forEach(word => {
                    tableHtml += `<tr>
                        <td>${word.word}</td>
                        <td>${word.status}</td>
                        <td>${word.translation}</td>
                    </tr>`;
                });
                tableHtml += "</table>";
                document.getElementById('wordListContainer').innerHTML = tableHtml;
            } else {
                document.getElementById('wordListContainer').innerHTML = "今天没有需要复习的单词。";
            }
        }

        // 查看按钮逻辑：显示今天复习的单词列表
        document.getElementById('viewWordsButton').addEventListener('click', function() {
            loadTodayWords();
        });

        // 复习按钮逻辑：跳转到复习页面
        document.getElementById('reviewWordsButton').addEventListener('click', function() {
            window.location.href = "review.html";
        });

        // 测试按钮逻辑：跳转到测试页面
        document.getElementById('testWordsButton').addEventListener('click', function() {
            window.location.href = "testing.html";
        });

        // 页面加载时初始化数据并加载今天的单词
        window.addEventListener('load', async () => {
            await initializeData();
            loadTodayWords();
        });
    </script>
</body>
</html>
