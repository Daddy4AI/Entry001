<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build a Strong Vocabulary</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
        }
        table {
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
        footer {
            text-align: center;
            font-size: 12px;
            color: grey;
            margin-top: 50px;
        }
    </style>
</head>
<body>
    <h1>Build a Strong Vocabulary</h1>

    <button id="viewWordsButton">查看</button>
    <button id="reviewWordsButton">复习</button>
    <button id="testWordsButton">测试</button>

    <div id="wordListContainer"></div>

    <footer>version 002</footer>

    <script type="module">
        import { database } from './firebaseConfig.js';
        import { ref, get } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

        async function getMaxWordN() {
            try {
                const settingsRef = ref(database, 'examSettings/maxWordN');
                const snapshot = await get(settingsRef);
                return snapshot.exists() ? snapshot.val() : 25;  // 默认 25
            } catch (error) {
                console.error('获取 maxWordN 时出错:', error);
                return 25;
            }
        }

        function setWordStatus(word, result) {
            if (!result || result.test_attempt === 0) {
                if (!result || result.review_attempt === 0) {
                    return "新单词";
                }
            } else if (result.review_attempt === 0) {
                return "初始复习";
            } else {
                return `第${result.review_attempt}次复习`;
            }
        }

        async function loadTodayWords() {
            const maxWordN = await getMaxWordN();  // 动态获取 maxWordN
            const todayWordList = [];

            const [wordSnapshot, testResultSnapshot] = await Promise.all([
                get(ref(database, 'wordlist')),
                get(ref(database, 'TestResult'))
            ]);

            if (!wordSnapshot.exists() || !testResultSnapshot.exists()) {
                console.error('No wordlist or test results found.');
                return;
            }

            const words = wordSnapshot.val();
            const testResults = testResultSnapshot.val();
            const wordArray = Object.values(words);

            function addWordsToList(filteredWords) {
                const remainingSlots = maxWordN - todayWordList.length;
                todayWordList.push(...filteredWords.slice(0, remainingSlots));
            }

            const todayExamId = Math.max(...Object.values(testResults).map(r => r.exam_id)) + 1;

            const YWWord = wordArray.filter(word => {
                const result = testResults[word.id];
                word.status = setWordStatus(word, result);
                return (
                    result &&
                    result.review_attempt === 0 &&
                    result.exam_id === todayExamId - 1 &&
                    result.test_result === false
                );
            });
            addWordsToList(YWWord);

            const R2Word = wordArray.filter(word => {
                const result = testResults[word.id];
                word.status = setWordStatus(word, result);
                return (
                    result &&
                    result.review_attempt === 1 &&
                    result.exam_id <= todayExamId - 2
                );
            });
            addWordsToList(R2Word);

            const R6Word = wordArray.filter(word => {
                const result = testResults[word.id];
                word.status = setWordStatus(word, result);
                return (
                    result &&
                    result.review_attempt === 2 &&
                    result.exam_id <= todayExamId - 6
                );
            });
            addWordsToList(R6Word);

            const R13Word = wordArray.filter(word => {
                const result = testResults[word.id];
                word.status = setWordStatus(word, result);
                return (
                    result &&
                    result.review_attempt === 3 &&
                    result.exam_id <= todayExamId - 13
                );
            });
            addWordsToList(R13Word);

            const R20Word = wordArray.filter(word => {
                const result = testResults[word.id];
                word.status = setWordStatus(word, result);
                return (
                    result &&
                    result.review_attempt === 4 &&
                    result.exam_id <= todayExamId - 20
                );
            });
            addWordsToList(R20Word);

            if (todayWordList.length < maxWordN) {
                const untestedWords = wordArray.filter(word =>
                    !testResults[word.id] || testResults[word.id].test_attempt === 0
                );
                untestedWords.forEach(word => {
                    word.status = "新单词";
                });
                addWordsToList(untestedWords);
            }

            displayWords(todayWordList);

                // 保存 todayWordList 到 localStorage
            localStorage.setItem("todayWordList", JSON.stringify(todayWordList));

        }

        function displayWords(wordList) {
            if (wordList.length > 0) {
                let tableHtml = `<table>
                    <tr><th>单词</th><th>状态</th><th>翻译</th></tr>`;
                wordList.forEach(word => {
                    tableHtml += `<tr>
                        <td>${word.word}</td>
                        <td>${word.status}</td>
                        <td>${word.translation || 'N/A'}</td>
                    </tr>`;
                });
                tableHtml += "</table>";
                document.getElementById('wordListContainer').innerHTML = tableHtml;
            } else {
                document.getElementById('wordListContainer').innerHTML = "今天没有需要复习的单词。";
            }
        }

        document.getElementById('viewWordsButton').addEventListener('click', loadTodayWords);

        document.getElementById('reviewWordsButton').addEventListener('click', () => {
            window.location.href = "review.html";
        });

        document.getElementById('testWordsButton').addEventListener('click', () => {
            window.location.href = "testing.html";
        });

        window.addEventListener('load', loadTodayWords);
    </script>
</body>
</html>
